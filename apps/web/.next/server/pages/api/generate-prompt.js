"use strict";
/*
 * ATTENTION: An "eval-source-map" devtool has been used.
 * This devtool is neither made for production nor for readable output files.
 * It uses "eval()" calls to create a separate source file with attached SourceMaps in the browser devtools.
 * If you are trying to read the output file, select a different devtool (https://webpack.js.org/configuration/devtool/)
 * or disable the default devtool with "devtool: false".
 * If you are looking for production-ready output files, see mode: "production" (https://webpack.js.org/configuration/mode/).
 */
(() => {
var exports = {};
exports.id = "pages/api/generate-prompt";
exports.ids = ["pages/api/generate-prompt"];
exports.modules = {

/***/ "@supabase/ssr":
/*!********************************!*\
  !*** external "@supabase/ssr" ***!
  \********************************/
/***/ ((module) => {

module.exports = require("@supabase/ssr");

/***/ }),

/***/ "next/dist/compiled/next-server/pages-api.runtime.dev.js":
/*!**************************************************************************!*\
  !*** external "next/dist/compiled/next-server/pages-api.runtime.dev.js" ***!
  \**************************************************************************/
/***/ ((module) => {

module.exports = require("next/dist/compiled/next-server/pages-api.runtime.dev.js");

/***/ }),

/***/ "fs":
/*!*********************!*\
  !*** external "fs" ***!
  \*********************/
/***/ ((module) => {

module.exports = require("fs");

/***/ }),

/***/ "formidable":
/*!*****************************!*\
  !*** external "formidable" ***!
  \*****************************/
/***/ ((module) => {

module.exports = import("formidable");;

/***/ }),

/***/ "(api)/../../node_modules/next/dist/build/webpack/loaders/next-route-loader/index.js?kind=PAGES_API&page=%2Fapi%2Fgenerate-prompt&preferredRegion=&absolutePagePath=.%2Fpages%5Capi%5Cgenerate-prompt.js&middlewareConfigBase64=e30%3D!":
/*!****************************************************************************************************************************************************************************************************************************************!*\
  !*** ../../node_modules/next/dist/build/webpack/loaders/next-route-loader/index.js?kind=PAGES_API&page=%2Fapi%2Fgenerate-prompt&preferredRegion=&absolutePagePath=.%2Fpages%5Capi%5Cgenerate-prompt.js&middlewareConfigBase64=e30%3D! ***!
  \****************************************************************************************************************************************************************************************************************************************/
/***/ ((module, __webpack_exports__, __webpack_require__) => {

eval("__webpack_require__.a(module, async (__webpack_handle_async_dependencies__, __webpack_async_result__) => { try {\n__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   config: () => (/* binding */ config),\n/* harmony export */   \"default\": () => (__WEBPACK_DEFAULT_EXPORT__),\n/* harmony export */   routeModule: () => (/* binding */ routeModule)\n/* harmony export */ });\n/* harmony import */ var next_dist_server_future_route_modules_pages_api_module_compiled__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! next/dist/server/future/route-modules/pages-api/module.compiled */ \"(api)/../../node_modules/next/dist/server/future/route-modules/pages-api/module.compiled.js\");\n/* harmony import */ var next_dist_server_future_route_modules_pages_api_module_compiled__WEBPACK_IMPORTED_MODULE_0___default = /*#__PURE__*/__webpack_require__.n(next_dist_server_future_route_modules_pages_api_module_compiled__WEBPACK_IMPORTED_MODULE_0__);\n/* harmony import */ var next_dist_server_future_route_kind__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! next/dist/server/future/route-kind */ \"(api)/../../node_modules/next/dist/server/future/route-kind.js\");\n/* harmony import */ var next_dist_build_templates_helpers__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! next/dist/build/templates/helpers */ \"(api)/../../node_modules/next/dist/build/templates/helpers.js\");\n/* harmony import */ var _pages_api_generate_prompt_js__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! ./pages\\api\\generate-prompt.js */ \"(api)/./pages/api/generate-prompt.js\");\nvar __webpack_async_dependencies__ = __webpack_handle_async_dependencies__([_pages_api_generate_prompt_js__WEBPACK_IMPORTED_MODULE_3__]);\n_pages_api_generate_prompt_js__WEBPACK_IMPORTED_MODULE_3__ = (__webpack_async_dependencies__.then ? (await __webpack_async_dependencies__)() : __webpack_async_dependencies__)[0];\n\n\n\n// Import the userland code.\n\n// Re-export the handler (should be the default export).\n/* harmony default export */ const __WEBPACK_DEFAULT_EXPORT__ = ((0,next_dist_build_templates_helpers__WEBPACK_IMPORTED_MODULE_2__.hoist)(_pages_api_generate_prompt_js__WEBPACK_IMPORTED_MODULE_3__, \"default\"));\n// Re-export config.\nconst config = (0,next_dist_build_templates_helpers__WEBPACK_IMPORTED_MODULE_2__.hoist)(_pages_api_generate_prompt_js__WEBPACK_IMPORTED_MODULE_3__, \"config\");\n// Create and export the route module that will be consumed.\nconst routeModule = new next_dist_server_future_route_modules_pages_api_module_compiled__WEBPACK_IMPORTED_MODULE_0__.PagesAPIRouteModule({\n    definition: {\n        kind: next_dist_server_future_route_kind__WEBPACK_IMPORTED_MODULE_1__.RouteKind.PAGES_API,\n        page: \"/api/generate-prompt\",\n        pathname: \"/api/generate-prompt\",\n        // The following aren't used in production.\n        bundlePath: \"\",\n        filename: \"\"\n    },\n    userland: _pages_api_generate_prompt_js__WEBPACK_IMPORTED_MODULE_3__\n});\n\n//# sourceMappingURL=pages-api.js.map\n__webpack_async_result__();\n} catch(e) { __webpack_async_result__(e); } });//# sourceURL=[module]\n//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiKGFwaSkvLi4vLi4vbm9kZV9tb2R1bGVzL25leHQvZGlzdC9idWlsZC93ZWJwYWNrL2xvYWRlcnMvbmV4dC1yb3V0ZS1sb2FkZXIvaW5kZXguanM/a2luZD1QQUdFU19BUEkmcGFnZT0lMkZhcGklMkZnZW5lcmF0ZS1wcm9tcHQmcHJlZmVycmVkUmVnaW9uPSZhYnNvbHV0ZVBhZ2VQYXRoPS4lMkZwYWdlcyU1Q2FwaSU1Q2dlbmVyYXRlLXByb21wdC5qcyZtaWRkbGV3YXJlQ29uZmlnQmFzZTY0PWUzMCUzRCEiLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7QUFBc0c7QUFDdkM7QUFDTDtBQUMxRDtBQUM2RDtBQUM3RDtBQUNBLGlFQUFlLHdFQUFLLENBQUMsMERBQVEsWUFBWSxFQUFDO0FBQzFDO0FBQ08sZUFBZSx3RUFBSyxDQUFDLDBEQUFRO0FBQ3BDO0FBQ08sd0JBQXdCLGdIQUFtQjtBQUNsRDtBQUNBLGNBQWMseUVBQVM7QUFDdkI7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEtBQUs7QUFDTCxZQUFZO0FBQ1osQ0FBQzs7QUFFRCxxQyIsInNvdXJjZXMiOlsid2VicGFjazovL3dlYi8/N2MzZCJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBQYWdlc0FQSVJvdXRlTW9kdWxlIH0gZnJvbSBcIm5leHQvZGlzdC9zZXJ2ZXIvZnV0dXJlL3JvdXRlLW1vZHVsZXMvcGFnZXMtYXBpL21vZHVsZS5jb21waWxlZFwiO1xuaW1wb3J0IHsgUm91dGVLaW5kIH0gZnJvbSBcIm5leHQvZGlzdC9zZXJ2ZXIvZnV0dXJlL3JvdXRlLWtpbmRcIjtcbmltcG9ydCB7IGhvaXN0IH0gZnJvbSBcIm5leHQvZGlzdC9idWlsZC90ZW1wbGF0ZXMvaGVscGVyc1wiO1xuLy8gSW1wb3J0IHRoZSB1c2VybGFuZCBjb2RlLlxuaW1wb3J0ICogYXMgdXNlcmxhbmQgZnJvbSBcIi4vcGFnZXNcXFxcYXBpXFxcXGdlbmVyYXRlLXByb21wdC5qc1wiO1xuLy8gUmUtZXhwb3J0IHRoZSBoYW5kbGVyIChzaG91bGQgYmUgdGhlIGRlZmF1bHQgZXhwb3J0KS5cbmV4cG9ydCBkZWZhdWx0IGhvaXN0KHVzZXJsYW5kLCBcImRlZmF1bHRcIik7XG4vLyBSZS1leHBvcnQgY29uZmlnLlxuZXhwb3J0IGNvbnN0IGNvbmZpZyA9IGhvaXN0KHVzZXJsYW5kLCBcImNvbmZpZ1wiKTtcbi8vIENyZWF0ZSBhbmQgZXhwb3J0IHRoZSByb3V0ZSBtb2R1bGUgdGhhdCB3aWxsIGJlIGNvbnN1bWVkLlxuZXhwb3J0IGNvbnN0IHJvdXRlTW9kdWxlID0gbmV3IFBhZ2VzQVBJUm91dGVNb2R1bGUoe1xuICAgIGRlZmluaXRpb246IHtcbiAgICAgICAga2luZDogUm91dGVLaW5kLlBBR0VTX0FQSSxcbiAgICAgICAgcGFnZTogXCIvYXBpL2dlbmVyYXRlLXByb21wdFwiLFxuICAgICAgICBwYXRobmFtZTogXCIvYXBpL2dlbmVyYXRlLXByb21wdFwiLFxuICAgICAgICAvLyBUaGUgZm9sbG93aW5nIGFyZW4ndCB1c2VkIGluIHByb2R1Y3Rpb24uXG4gICAgICAgIGJ1bmRsZVBhdGg6IFwiXCIsXG4gICAgICAgIGZpbGVuYW1lOiBcIlwiXG4gICAgfSxcbiAgICB1c2VybGFuZFxufSk7XG5cbi8vIyBzb3VyY2VNYXBwaW5nVVJMPXBhZ2VzLWFwaS5qcy5tYXAiXSwibmFtZXMiOltdLCJzb3VyY2VSb290IjoiIn0=\n//# sourceURL=webpack-internal:///(api)/../../node_modules/next/dist/build/webpack/loaders/next-route-loader/index.js?kind=PAGES_API&page=%2Fapi%2Fgenerate-prompt&preferredRegion=&absolutePagePath=.%2Fpages%5Capi%5Cgenerate-prompt.js&middlewareConfigBase64=e30%3D!\n");

/***/ }),

/***/ "(api)/./pages/api/generate-prompt.js":
/*!**************************************!*\
  !*** ./pages/api/generate-prompt.js ***!
  \**************************************/
/***/ ((module, __webpack_exports__, __webpack_require__) => {

eval("__webpack_require__.a(module, async (__webpack_handle_async_dependencies__, __webpack_async_result__) => { try {\n__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   config: () => (/* binding */ config),\n/* harmony export */   \"default\": () => (/* binding */ handler)\n/* harmony export */ });\n/* harmony import */ var fs__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! fs */ \"fs\");\n/* harmony import */ var fs__WEBPACK_IMPORTED_MODULE_0___default = /*#__PURE__*/__webpack_require__.n(fs__WEBPACK_IMPORTED_MODULE_0__);\n/* harmony import */ var formidable__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! formidable */ \"formidable\");\n/* harmony import */ var _supabase_ssr__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! @supabase/ssr */ \"@supabase/ssr\");\n/* harmony import */ var _supabase_ssr__WEBPACK_IMPORTED_MODULE_2___default = /*#__PURE__*/__webpack_require__.n(_supabase_ssr__WEBPACK_IMPORTED_MODULE_2__);\n/* harmony import */ var prompt_model__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! prompt-model */ \"(api)/../../packages/prompt-model/index.js\");\nvar __webpack_async_dependencies__ = __webpack_handle_async_dependencies__([formidable__WEBPACK_IMPORTED_MODULE_1__]);\nformidable__WEBPACK_IMPORTED_MODULE_1__ = (__webpack_async_dependencies__.then ? (await __webpack_async_dependencies__)() : __webpack_async_dependencies__)[0];\n\n\n\n\n// Turn off the default body parser, as we're using formidable\nconst config = {\n    api: {\n        bodyParser: false\n    }\n};\nconst PREDEFINED_STYLE_TAGS = [\n    \"photorealistic\",\n    \"4k\",\n    \"8k\",\n    \"cinematic\",\n    \"anime\",\n    \"impressionistic\",\n    \"oil painting\",\n    \"studio lighting\",\n    \"epic\",\n    \"concept art\",\n    \"fantasy\",\n    \"sci-fi\",\n    \"cyberpunk\",\n    \"steampunk\",\n    \"noir\",\n    \"minimalist\",\n    \"abstract\",\n    \"watercolor\",\n    \"cartoon\",\n    \"cel-shaded\",\n    \"low poly\",\n    \"pixel art\",\n    \"vaporwave\"\n];\nfunction extractStyleTags(promptText) {\n    const lowerCasePrompt = promptText.toLowerCase();\n    const foundTags = PREDEFINED_STYLE_TAGS.filter((tag)=>lowerCasePrompt.includes(tag));\n    return foundTags;\n}\nasync function handler(req, res) {\n    console.log(\"Supabase URL:\",  true ? \"Loaded\" : 0);\n    console.log(\"Supabase Anon Key:\",  true ? \"Loaded\" : 0);\n    console.log(\"Supabase Service Role Key:\", process.env.SUPABASE_SERVICE_ROLE_KEY ? \"Loaded\" : \"NOT LOADED\");\n    if (req.method !== \"POST\") {\n        res.setHeader(\"Allow\", \"POST\");\n        return res.status(405).end(\"Method Not Allowed\");\n    }\n    const supabase = (0,_supabase_ssr__WEBPACK_IMPORTED_MODULE_2__.createPagesServerClient)({\n        req,\n        res\n    });\n    const { data: { user } } = await supabase.auth.getUser();\n    if (!user) {\n        return res.status(401).json({\n            error: \"Unauthorized\"\n        });\n    }\n    // Fetch user profile to check subscription status\n    const { data: profile, error: profileError } = await supabase.from(\"users\").select(\"subscription_status\").eq(\"id\", user.id).single();\n    if (profileError && profileError.code !== \"PGRST116\") {\n        console.error(\"Error fetching user profile:\", profileError);\n        return res.status(500).json({\n            error: \"Could not fetch user profile.\"\n        });\n    }\n    // Apply rate limit based on user's tier\n    const userTier = profile?.subscription_status || \"free\";\n    const limit = userTier === \"premium\" ? 60 : 5;\n    const oneMinuteAgo = new Date(Date.now() - 60000).toISOString();\n    const { count, error: countError } = await supabase.from(\"request_logs\").select(\"*\", {\n        count: \"exact\",\n        head: true\n    }).eq(\"user_id\", user.id).gte(\"created_at\", oneMinuteAgo);\n    if (countError) {\n        console.error(\"Error fetching request count:\", countError);\n        return res.status(500).json({\n            error: \"Could not verify request limit.\"\n        });\n    }\n    if (count >= limit) {\n        return res.status(429).json({\n            error: \"Too many requests.\",\n            message: `You have exceeded the request limit. Please try again later.`\n        });\n    }\n    try {\n        const { fields, files } = await new Promise((resolve, reject)=>{\n            const form = (0,formidable__WEBPACK_IMPORTED_MODULE_1__.formidable)();\n            form.parse(req, (err, fields, files)=>{\n                if (err) {\n                    return reject(err);\n                }\n                resolve({\n                    fields,\n                    files\n                });\n            });\n        });\n        const imageFile = files.image?.[0];\n        if (!imageFile) {\n            return res.status(400).json({\n                error: \"No image file uploaded.\"\n            });\n        }\n        // Log the request before processing\n        const { error: logError } = await supabase.from(\"request_logs\").insert({\n            user_id: user.id\n        });\n        if (logError) {\n            console.error(\"Error logging request:\", logError);\n        // Decide if you want to proceed even if logging fails\n        }\n        const generatedPrompt = await (0,prompt_model__WEBPACK_IMPORTED_MODULE_3__.getPromptFromImage)(imageFile.filepath);\n        const styleTags = extractStyleTags(generatedPrompt);\n        // Save to Supabase\n        const { data: storageData, error: storageError } = await supabase.storage.from(\"uploads\").upload(`${user.id}/${Date.now()}-${imageFile.originalFilename}`, {\n            file: fs__WEBPACK_IMPORTED_MODULE_0___default().createReadStream(imageFile.filepath),\n            contentType: imageFile.mimetype\n        }, {\n            upsert: true\n        });\n        if (storageError) throw storageError;\n        const { data: promptData, error: promptError } = await supabase.from(\"prompts\").insert({\n            user_id: user.id,\n            prompt_text: generatedPrompt,\n            style_tags: styleTags,\n            source: \"upload\"\n        }).select().single();\n        if (promptError) throw promptError;\n        const { error: imageError } = await supabase.from(\"images\").insert({\n            user_id: user.id,\n            prompt_id: promptData.id,\n            storage_path: storageData.path,\n            original_filename: imageFile.originalFilename\n        });\n        if (imageError) throw imageError;\n        res.status(200).json({\n            prompt: generatedPrompt\n        });\n    } catch (error) {\n        console.error(\"API Error:\", error);\n        let errorMessage = \"Failed to generate prompt.\";\n        if (error.message.includes(\"bucket not found\")) {\n            errorMessage = \"Storage bucket 'uploads' not found. Please check your Supabase project.\";\n        }\n        return res.status(500).json({\n            error: errorMessage\n        });\n    }\n}\n\n__webpack_async_result__();\n} catch(e) { __webpack_async_result__(e); } });//# sourceURL=[module]\n//# sourceMappingURL=data:application/json;charset=utf-8;base64,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aEVDLE1BQU05RSwwREFBbUIsQ0FBQ2lFLFVBQVVNLFFBQVE7WUFDNUNTLGFBQWFmLFVBQVVnQixRQUFRO1FBQ2pDLEdBQUc7WUFDREMsUUFBUTtRQUNWO1FBRUYsSUFBSVIsY0FBYyxNQUFNQTtRQUV4QixNQUFNLEVBQUUzQyxNQUFNb0QsVUFBVSxFQUFFL0MsT0FBT2dELFdBQVcsRUFBRSxHQUFHLE1BQU10RCxTQUNwRFMsSUFBSSxDQUFDLFdBQ0w2QixNQUFNLENBQUM7WUFDTkMsU0FBU3JDLEtBQUtVLEVBQUU7WUFDaEIyQyxhQUFhZjtZQUNiZ0IsWUFBWWQ7WUFDWmUsUUFBUTtRQUNWLEdBQ0MvQyxNQUFNLEdBQ05HLE1BQU07UUFFVCxJQUFJeUMsYUFBYSxNQUFNQTtRQUV2QixNQUFNLEVBQUVoRCxPQUFPb0QsVUFBVSxFQUFFLEdBQUcsTUFBTTFELFNBQVNTLElBQUksQ0FBQyxVQUFVNkIsTUFBTSxDQUFDO1lBQ2pFQyxTQUFTckMsS0FBS1UsRUFBRTtZQUNoQitDLFdBQVdOLFdBQVd6QyxFQUFFO1lBQ3hCZ0QsY0FBY2pCLFlBQVlrQixJQUFJO1lBQzlCQyxtQkFBbUIzQixVQUFVWSxnQkFBZ0I7UUFDL0M7UUFFQSxJQUFJVyxZQUFZLE1BQU1BO1FBRXRCdEUsSUFBSVUsTUFBTSxDQUFDLEtBQUtPLElBQUksQ0FBQztZQUFFMEQsUUFBUXZCO1FBQWdCO0lBQ2pELEVBQUUsT0FBT2xDLE9BQU87UUFDZGpCLFFBQVFpQixLQUFLLENBQUMsY0FBY0E7UUFDNUIsSUFBSTBELGVBQWU7UUFDbkIsSUFBSTFELE1BQU1vQixPQUFPLENBQUN6QyxRQUFRLENBQUMscUJBQXFCO1lBQzlDK0UsZUFBZTtRQUNqQjtRQUNBLE9BQU81RSxJQUFJVSxNQUFNLENBQUMsS0FBS08sSUFBSSxDQUFDO1lBQUVDLE9BQU8wRDtRQUFhO0lBQ3BEO0FBQ0YiLCJzb3VyY2VzIjpbIndlYnBhY2s6Ly93ZWIvLi9wYWdlcy9hcGkvZ2VuZXJhdGUtcHJvbXB0LmpzP2NjZGQiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IGZzIGZyb20gXCJmc1wiO1xyXG5pbXBvcnQgeyBmb3JtaWRhYmxlIH0gZnJvbSBcImZvcm1pZGFibGVcIjtcclxuaW1wb3J0IHsgY3JlYXRlUGFnZXNTZXJ2ZXJDbGllbnQgfSBmcm9tICdAc3VwYWJhc2Uvc3NyJztcclxuaW1wb3J0IHsgZ2V0UHJvbXB0RnJvbUltYWdlIH0gZnJvbSBcInByb21wdC1tb2RlbFwiO1xyXG5cclxuLy8gVHVybiBvZmYgdGhlIGRlZmF1bHQgYm9keSBwYXJzZXIsIGFzIHdlJ3JlIHVzaW5nIGZvcm1pZGFibGVcclxuZXhwb3J0IGNvbnN0IGNvbmZpZyA9IHtcclxuICBhcGk6IHtcclxuICAgIGJvZHlQYXJzZXI6IGZhbHNlLFxyXG4gIH0sXHJcbn07XHJcblxyXG5jb25zdCBQUkVERUZJTkVEX1NUWUxFX1RBR1MgPSBbXHJcbiAgXCJwaG90b3JlYWxpc3RpY1wiLCBcIjRrXCIsIFwiOGtcIiwgXCJjaW5lbWF0aWNcIiwgXCJhbmltZVwiLCBcImltcHJlc3Npb25pc3RpY1wiLFxyXG4gIFwib2lsIHBhaW50aW5nXCIsIFwic3R1ZGlvIGxpZ2h0aW5nXCIsIFwiZXBpY1wiLCBcImNvbmNlcHQgYXJ0XCIsIFwiZmFudGFzeVwiLFxyXG4gIFwic2NpLWZpXCIsIFwiY3liZXJwdW5rXCIsIFwic3RlYW1wdW5rXCIsIFwibm9pclwiLCBcIm1pbmltYWxpc3RcIiwgXCJhYnN0cmFjdFwiLFxyXG4gIFwid2F0ZXJjb2xvclwiLCBcImNhcnRvb25cIiwgXCJjZWwtc2hhZGVkXCIsIFwibG93IHBvbHlcIiwgXCJwaXhlbCBhcnRcIiwgXCJ2YXBvcndhdmVcIlxyXG5dO1xyXG5cclxuZnVuY3Rpb24gZXh0cmFjdFN0eWxlVGFncyhwcm9tcHRUZXh0KSB7XHJcbiAgY29uc3QgbG93ZXJDYXNlUHJvbXB0ID0gcHJvbXB0VGV4dC50b0xvd2VyQ2FzZSgpO1xyXG4gIGNvbnN0IGZvdW5kVGFncyA9IFBSRURFRklORURfU1RZTEVfVEFHUy5maWx0ZXIodGFnID0+XHJcbiAgICBsb3dlckNhc2VQcm9tcHQuaW5jbHVkZXModGFnKVxyXG4gICk7XHJcbiAgcmV0dXJuIGZvdW5kVGFncztcclxufVxyXG5cclxuZXhwb3J0IGRlZmF1bHQgYXN5bmMgZnVuY3Rpb24gaGFuZGxlcihyZXEsIHJlcykge1xyXG4gIGNvbnNvbGUubG9nKFwiU3VwYWJhc2UgVVJMOlwiLCBwcm9jZXNzLmVudi5ORVhUX1BVQkxJQ19TVVBBQkFTRV9VUkwgPyBcIkxvYWRlZFwiIDogXCJOT1QgTE9BREVEXCIpO1xyXG4gIGNvbnNvbGUubG9nKFwiU3VwYWJhc2UgQW5vbiBLZXk6XCIsIHByb2Nlc3MuZW52Lk5FWFRfUFVCTElDX1NVUEFCQVNFX0FOT05fS0VZID8gXCJMb2FkZWRcIiA6IFwiTk9UIExPQURFRFwiKTtcclxuICBjb25zb2xlLmxvZyhcIlN1cGFiYXNlIFNlcnZpY2UgUm9sZSBLZXk6XCIsIHByb2Nlc3MuZW52LlNVUEFCQVNFX1NFUlZJQ0VfUk9MRV9LRVkgPyBcIkxvYWRlZFwiIDogXCJOT1QgTE9BREVEXCIpO1xyXG5cclxuICBpZiAocmVxLm1ldGhvZCAhPT0gXCJQT1NUXCIpIHtcclxuICAgIHJlcy5zZXRIZWFkZXIoXCJBbGxvd1wiLCBcIlBPU1RcIik7XHJcbiAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDUpLmVuZChcIk1ldGhvZCBOb3QgQWxsb3dlZFwiKTtcclxuICB9XHJcblxyXG4gIGNvbnN0IHN1cGFiYXNlID0gY3JlYXRlUGFnZXNTZXJ2ZXJDbGllbnQoeyByZXEsIHJlcyB9KTtcclxuICBjb25zdCB7XHJcbiAgICBkYXRhOiB7IHVzZXIgfSxcclxuICB9ID0gYXdhaXQgc3VwYWJhc2UuYXV0aC5nZXRVc2VyKCk7XHJcblxyXG4gIGlmICghdXNlcikge1xyXG4gICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAxKS5qc29uKHsgZXJyb3I6IFwiVW5hdXRob3JpemVkXCIgfSk7XHJcbiAgfVxyXG5cclxuICAvLyBGZXRjaCB1c2VyIHByb2ZpbGUgdG8gY2hlY2sgc3Vic2NyaXB0aW9uIHN0YXR1c1xyXG4gIGNvbnN0IHsgZGF0YTogcHJvZmlsZSwgZXJyb3I6IHByb2ZpbGVFcnJvciB9ID0gYXdhaXQgc3VwYWJhc2VcclxuICAgIC5mcm9tKFwidXNlcnNcIilcclxuICAgIC5zZWxlY3QoXCJzdWJzY3JpcHRpb25fc3RhdHVzXCIpXHJcbiAgICAuZXEoXCJpZFwiLCB1c2VyLmlkKVxyXG4gICAgLnNpbmdsZSgpO1xyXG5cclxuICBpZiAocHJvZmlsZUVycm9yICYmIHByb2ZpbGVFcnJvci5jb2RlICE9PSAnUEdSU1QxMTYnKSB7IC8vIElnbm9yZSBpZiBubyBwcm9maWxlIHJvdyBleGlzdHMgeWV0XHJcbiAgICBjb25zb2xlLmVycm9yKFwiRXJyb3IgZmV0Y2hpbmcgdXNlciBwcm9maWxlOlwiLCBwcm9maWxlRXJyb3IpO1xyXG4gICAgcmV0dXJuIHJlcy5zdGF0dXMoNTAwKS5qc29uKHsgZXJyb3I6IFwiQ291bGQgbm90IGZldGNoIHVzZXIgcHJvZmlsZS5cIiB9KTtcclxuICB9XHJcblxyXG4gIC8vIEFwcGx5IHJhdGUgbGltaXQgYmFzZWQgb24gdXNlcidzIHRpZXJcclxuICBjb25zdCB1c2VyVGllciA9IHByb2ZpbGU/LnN1YnNjcmlwdGlvbl9zdGF0dXMgfHwgJ2ZyZWUnO1xyXG4gIGNvbnN0IGxpbWl0ID0gdXNlclRpZXIgPT09ICdwcmVtaXVtJyA/IDYwIDogNTtcclxuICBjb25zdCBvbmVNaW51dGVBZ28gPSBuZXcgRGF0ZShEYXRlLm5vdygpIC0gNjAwMDApLnRvSVNPU3RyaW5nKCk7XHJcblxyXG4gIGNvbnN0IHsgY291bnQsIGVycm9yOiBjb3VudEVycm9yIH0gPSBhd2FpdCBzdXBhYmFzZVxyXG4gICAgLmZyb20oJ3JlcXVlc3RfbG9ncycpXHJcbiAgICAuc2VsZWN0KCcqJywgeyBjb3VudDogJ2V4YWN0JywgaGVhZDogdHJ1ZSB9KVxyXG4gICAgLmVxKCd1c2VyX2lkJywgdXNlci5pZClcclxuICAgIC5ndGUoJ2NyZWF0ZWRfYXQnLCBvbmVNaW51dGVBZ28pO1xyXG5cclxuICBpZiAoY291bnRFcnJvcikge1xyXG4gICAgY29uc29sZS5lcnJvcihcIkVycm9yIGZldGNoaW5nIHJlcXVlc3QgY291bnQ6XCIsIGNvdW50RXJyb3IpO1xyXG4gICAgcmV0dXJuIHJlcy5zdGF0dXMoNTAwKS5qc29uKHsgZXJyb3I6IFwiQ291bGQgbm90IHZlcmlmeSByZXF1ZXN0IGxpbWl0LlwiIH0pO1xyXG4gIH1cclxuXHJcbiAgaWYgKGNvdW50ID49IGxpbWl0KSB7XHJcbiAgICByZXR1cm4gcmVzLnN0YXR1cyg0MjkpLmpzb24oe1xyXG4gICAgICBlcnJvcjogXCJUb28gbWFueSByZXF1ZXN0cy5cIixcclxuICAgICAgbWVzc2FnZTogYFlvdSBoYXZlIGV4Y2VlZGVkIHRoZSByZXF1ZXN0IGxpbWl0LiBQbGVhc2UgdHJ5IGFnYWluIGxhdGVyLmAsXHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIHRyeSB7XHJcbiAgICBjb25zdCB7IGZpZWxkcywgZmlsZXMgfSA9IGF3YWl0IG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcclxuICAgICAgY29uc3QgZm9ybSA9IGZvcm1pZGFibGUoKTtcclxuICAgICAgZm9ybS5wYXJzZShyZXEsIChlcnIsIGZpZWxkcywgZmlsZXMpID0+IHtcclxuICAgICAgICBpZiAoZXJyKSB7XHJcbiAgICAgICAgICByZXR1cm4gcmVqZWN0KGVycik7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJlc29sdmUoeyBmaWVsZHMsIGZpbGVzIH0pO1xyXG4gICAgICB9KTtcclxuICAgIH0pO1xyXG5cclxuICAgIGNvbnN0IGltYWdlRmlsZSA9IGZpbGVzLmltYWdlPy5bMF07XHJcblxyXG4gICAgaWYgKCFpbWFnZUZpbGUpIHtcclxuICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAwKS5qc29uKHsgZXJyb3I6IFwiTm8gaW1hZ2UgZmlsZSB1cGxvYWRlZC5cIiB9KTtcclxuICAgIH1cclxuXHJcbiAgICAvLyBMb2cgdGhlIHJlcXVlc3QgYmVmb3JlIHByb2Nlc3NpbmdcclxuICAgIGNvbnN0IHsgZXJyb3I6IGxvZ0Vycm9yIH0gPSBhd2FpdCBzdXBhYmFzZS5mcm9tKCdyZXF1ZXN0X2xvZ3MnKS5pbnNlcnQoeyB1c2VyX2lkOiB1c2VyLmlkIH0pO1xyXG4gICAgaWYgKGxvZ0Vycm9yKSB7XHJcbiAgICAgIGNvbnNvbGUuZXJyb3IoXCJFcnJvciBsb2dnaW5nIHJlcXVlc3Q6XCIsIGxvZ0Vycm9yKTtcclxuICAgICAgLy8gRGVjaWRlIGlmIHlvdSB3YW50IHRvIHByb2NlZWQgZXZlbiBpZiBsb2dnaW5nIGZhaWxzXHJcbiAgICB9XHJcblxyXG4gICAgY29uc3QgZ2VuZXJhdGVkUHJvbXB0ID0gYXdhaXQgZ2V0UHJvbXB0RnJvbUltYWdlKGltYWdlRmlsZS5maWxlcGF0aCk7XHJcbiAgICBjb25zdCBzdHlsZVRhZ3MgPSBleHRyYWN0U3R5bGVUYWdzKGdlbmVyYXRlZFByb21wdCk7XHJcblxyXG4gICAgLy8gU2F2ZSB0byBTdXBhYmFzZVxyXG4gICAgY29uc3QgeyBkYXRhOiBzdG9yYWdlRGF0YSwgZXJyb3I6IHN0b3JhZ2VFcnJvciB9ID0gYXdhaXQgc3VwYWJhc2Uuc3RvcmFnZVxyXG4gICAgICAuZnJvbShcInVwbG9hZHNcIilcclxuICAgICAgLnVwbG9hZChgJHt1c2VyLmlkfS8ke0RhdGUubm93KCl9LSR7aW1hZ2VGaWxlLm9yaWdpbmFsRmlsZW5hbWV9YCwge1xyXG4gICAgICAgIGZpbGU6IGZzLmNyZWF0ZVJlYWRTdHJlYW0oaW1hZ2VGaWxlLmZpbGVwYXRoKSxcclxuICAgICAgICBjb250ZW50VHlwZTogaW1hZ2VGaWxlLm1pbWV0eXBlLFxyXG4gICAgICB9LCB7XHJcbiAgICAgICAgdXBzZXJ0OiB0cnVlLFxyXG4gICAgICB9KTtcclxuXHJcbiAgICBpZiAoc3RvcmFnZUVycm9yKSB0aHJvdyBzdG9yYWdlRXJyb3I7XHJcblxyXG4gICAgY29uc3QgeyBkYXRhOiBwcm9tcHREYXRhLCBlcnJvcjogcHJvbXB0RXJyb3IgfSA9IGF3YWl0IHN1cGFiYXNlXHJcbiAgICAgIC5mcm9tKFwicHJvbXB0c1wiKVxyXG4gICAgICAuaW5zZXJ0KHtcclxuICAgICAgICB1c2VyX2lkOiB1c2VyLmlkLFxyXG4gICAgICAgIHByb21wdF90ZXh0OiBnZW5lcmF0ZWRQcm9tcHQsXHJcbiAgICAgICAgc3R5bGVfdGFnczogc3R5bGVUYWdzLFxyXG4gICAgICAgIHNvdXJjZTogXCJ1cGxvYWRcIixcclxuICAgICAgfSlcclxuICAgICAgLnNlbGVjdCgpXHJcbiAgICAgIC5zaW5nbGUoKTtcclxuXHJcbiAgICBpZiAocHJvbXB0RXJyb3IpIHRocm93IHByb21wdEVycm9yO1xyXG5cclxuICAgIGNvbnN0IHsgZXJyb3I6IGltYWdlRXJyb3IgfSA9IGF3YWl0IHN1cGFiYXNlLmZyb20oXCJpbWFnZXNcIikuaW5zZXJ0KHtcclxuICAgICAgdXNlcl9pZDogdXNlci5pZCxcclxuICAgICAgcHJvbXB0X2lkOiBwcm9tcHREYXRhLmlkLFxyXG4gICAgICBzdG9yYWdlX3BhdGg6IHN0b3JhZ2VEYXRhLnBhdGgsXHJcbiAgICAgIG9yaWdpbmFsX2ZpbGVuYW1lOiBpbWFnZUZpbGUub3JpZ2luYWxGaWxlbmFtZSxcclxuICAgIH0pO1xyXG5cclxuICAgIGlmIChpbWFnZUVycm9yKSB0aHJvdyBpbWFnZUVycm9yO1xyXG5cclxuICAgIHJlcy5zdGF0dXMoMjAwKS5qc29uKHsgcHJvbXB0OiBnZW5lcmF0ZWRQcm9tcHQgfSk7XHJcbiAgfSBjYXRjaCAoZXJyb3IpIHtcclxuICAgIGNvbnNvbGUuZXJyb3IoXCJBUEkgRXJyb3I6XCIsIGVycm9yKTtcclxuICAgIGxldCBlcnJvck1lc3NhZ2UgPSBcIkZhaWxlZCB0byBnZW5lcmF0ZSBwcm9tcHQuXCI7XHJcbiAgICBpZiAoZXJyb3IubWVzc2FnZS5pbmNsdWRlcyhcImJ1Y2tldCBub3QgZm91bmRcIikpIHtcclxuICAgICAgZXJyb3JNZXNzYWdlID0gXCJTdG9yYWdlIGJ1Y2tldCAndXBsb2Fkcycgbm90IGZvdW5kLiBQbGVhc2UgY2hlY2sgeW91ciBTdXBhYmFzZSBwcm9qZWN0LlwiO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIHJlcy5zdGF0dXMoNTAwKS5qc29uKHsgZXJyb3I6IGVycm9yTWVzc2FnZSB9KTtcclxuICB9XHJcbn0iXSwibmFtZXMiOlsiZnMiLCJmb3JtaWRhYmxlIiwiY3JlYXRlUGFnZXNTZXJ2ZXJDbGllbnQiLCJnZXRQcm9tcHRGcm9tSW1hZ2UiLCJjb25maWciLCJhcGkiLCJib2R5UGFyc2VyIiwiUFJFREVGSU5FRF9TVFlMRV9UQUdTIiwiZXh0cmFjdFN0eWxlVGFncyIsInByb21wdFRleHQiLCJsb3dlckNhc2VQcm9tcHQiLCJ0b0xvd2VyQ2FzZSIsImZvdW5kVGFncyIsImZpbHRlciIsInRhZyIsImluY2x1ZGVzIiwiaGFuZGxlciIsInJlcSIsInJlcyIsImNvbnNvbGUiLCJsb2ciLCJwcm9jZXNzIiwiZW52IiwiTkVYVF9QVUJMSUNfU1VQQUJBU0VfVVJMIiwiTkVYVF9QVUJMSUNfU1VQQUJBU0VfQU5PTl9LRVkiLCJTVVBBQkFTRV9TRVJWSUNFX1JPTEVfS0VZIiwibWV0aG9kIiwic2V0SGVhZGVyIiwic3RhdHVzIiwiZW5kIiwic3VwYWJhc2UiLCJkYXRhIiwidXNlciIsImF1dGgiLCJnZXRVc2VyIiwianNvbiIsImVycm9yIiwicHJvZmlsZSIsInByb2ZpbGVFcnJvciIsImZyb20iLCJzZWxlY3QiLCJlcSIsImlkIiwic2luZ2xlIiwiY29kZSIsInVzZXJUaWVyIiwic3Vic2NyaXB0aW9uX3N0YXR1cyIsImxpbWl0Iiwib25lTWludXRlQWdvIiwiRGF0ZSIsIm5vdyIsInRvSVNPU3RyaW5nIiwiY291bnQiLCJjb3VudEVycm9yIiwiaGVhZCIsImd0ZSIsIm1lc3NhZ2UiLCJmaWVsZHMiLCJmaWxlcyIsIlByb21pc2UiLCJyZXNvbHZlIiwicmVqZWN0IiwiZm9ybSIsInBhcnNlIiwiZXJyIiwiaW1hZ2VGaWxlIiwiaW1hZ2UiLCJsb2dFcnJvciIsImluc2VydCIsInVzZXJfaWQiLCJnZW5lcmF0ZWRQcm9tcHQiLCJmaWxlcGF0aCIsInN0eWxlVGFncyIsInN0b3JhZ2VEYXRhIiwic3RvcmFnZUVycm9yIiwic3RvcmFnZSIsInVwbG9hZCIsIm9yaWdpbmFsRmlsZW5hbWUiLCJmaWxlIiwiY3JlYXRlUmVhZFN0cmVhbSIsImNvbnRlbnRUeXBlIiwibWltZXR5cGUiLCJ1cHNlcnQiLCJwcm9tcHREYXRhIiwicHJvbXB0RXJyb3IiLCJwcm9tcHRfdGV4dCIsInN0eWxlX3RhZ3MiLCJzb3VyY2UiLCJpbWFnZUVycm9yIiwicHJvbXB0X2lkIiwic3RvcmFnZV9wYXRoIiwicGF0aCIsIm9yaWdpbmFsX2ZpbGVuYW1lIiwicHJvbXB0IiwiZXJyb3JNZXNzYWdlIl0sInNvdXJjZVJvb3QiOiIifQ==\n//# sourceURL=webpack-internal:///(api)/./pages/api/generate-prompt.js\n");

/***/ }),

/***/ "(api)/../../packages/prompt-model/index.js":
/*!********************************************!*\
  !*** ../../packages/prompt-model/index.js ***!
  \********************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

eval("__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   getPromptFromImage: () => (/* binding */ getPromptFromImage)\n/* harmony export */ });\n/* harmony import */ var fs__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! fs */ \"fs\");\n/* harmony import */ var fs__WEBPACK_IMPORTED_MODULE_0___default = /*#__PURE__*/__webpack_require__.n(fs__WEBPACK_IMPORTED_MODULE_0__);\n\nconst MODEL_API_URL = \"https://api-inference.huggingface.co/models/salesforce/blip-image-captioning-large\";\n/**\r\n * A generic helper to query a Hugging Face Inference API.\r\n * @param {string} apiUrl The full URL of the model's inference API.\r\n * @param {Buffer} data The data to send (e.g., an image buffer).\r\n * @returns {Promise<object>} The JSON response from the API.\r\n */ async function queryHuggingFace(apiUrl, data) {\n    const apiKey = process.env.HUGGING_FACE_API_KEY;\n    console.log(\"Hugging Face API Key:\", apiKey ? \"Loaded\" : \"NOT LOADED\");\n    if (!apiKey) {\n        throw new Error(\"Hugging Face API key is not configured.\");\n    }\n    const response = await fetch(apiUrl, {\n        headers: {\n            Authorization: `Bearer ${apiKey}`\n        },\n        method: \"POST\",\n        body: data\n    });\n    if (!response.ok) {\n        const responseText = await response.text();\n        console.error(\"Hugging Face API Error Response:\", responseText);\n        const errorMsg = `Hugging Face API error: ${response.statusText}`;\n        throw new Error(errorMsg);\n    }\n    const result = await response.json();\n    return result;\n}\n/**\r\n * Generates a prompt from an image file by calling the Hugging Face Inference API.\r\n * @param {string} imagePath The local path to the image file.\r\n * @returns {Promise<string>} The generated prompt text.\r\n * @throws {Error} If the API call fails or the API key is missing.\r\n */ async function getPromptFromImage(imagePath) {\n    // Read the image file from the temporary path\n    const imageBuffer = fs__WEBPACK_IMPORTED_MODULE_0___default().readFileSync(imagePath);\n    const result = await queryHuggingFace(MODEL_API_URL, imageBuffer);\n    return result[0]?.generated_text || \"Could not generate a prompt for this image.\";\n}\n//# sourceURL=[module]\n//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiKGFwaSkvLi4vLi4vcGFja2FnZXMvcHJvbXB0LW1vZGVsL2luZGV4LmpzIiwibWFwcGluZ3MiOiI7Ozs7OztBQUFvQjtBQUVwQixNQUFNQyxnQkFDSjtBQUVGOzs7OztDQUtDLEdBQ0QsZUFBZUMsaUJBQWlCQyxNQUFNLEVBQUVDLElBQUk7SUFDMUMsTUFBTUMsU0FBU0MsUUFBUUMsR0FBRyxDQUFDQyxvQkFBb0I7SUFDL0NDLFFBQVFDLEdBQUcsQ0FBQyx5QkFBeUJMLFNBQVMsV0FBVztJQUV6RCxJQUFJLENBQUNBLFFBQVE7UUFDWCxNQUFNLElBQUlNLE1BQU07SUFDbEI7SUFFQSxNQUFNQyxXQUFXLE1BQU1DLE1BQU1WLFFBQVE7UUFDbkNXLFNBQVM7WUFDUEMsZUFBZSxDQUFDLE9BQU8sRUFBRVYsT0FBTyxDQUFDO1FBQ25DO1FBQ0FXLFFBQVE7UUFDUkMsTUFBTWI7SUFDUjtJQUVBLElBQUksQ0FBQ1EsU0FBU00sRUFBRSxFQUFFO1FBQ2hCLE1BQU1DLGVBQWUsTUFBTVAsU0FBU1EsSUFBSTtRQUN4Q1gsUUFBUVksS0FBSyxDQUFDLG9DQUFvQ0Y7UUFDbEQsTUFBTUcsV0FBVyxDQUFDLHdCQUF3QixFQUFFVixTQUFTVyxVQUFVLENBQUMsQ0FBQztRQUNqRSxNQUFNLElBQUlaLE1BQU1XO0lBQ2xCO0lBRUEsTUFBTUUsU0FBUyxNQUFNWixTQUFTYSxJQUFJO0lBRWxDLE9BQU9EO0FBQ1Q7QUFFQTs7Ozs7Q0FLQyxHQUNNLGVBQWVFLG1CQUFtQkMsU0FBUztJQUNoRCw4Q0FBOEM7SUFDOUMsTUFBTUMsY0FBYzVCLHNEQUFlLENBQUMyQjtJQUVwQyxNQUFNSCxTQUFTLE1BQU10QixpQkFBaUJELGVBQWUyQjtJQUVyRCxPQUFPSixNQUFNLENBQUMsRUFBRSxFQUFFTSxrQkFBa0I7QUFDdEMiLCJzb3VyY2VzIjpbIndlYnBhY2s6Ly93ZWIvLi4vLi4vcGFja2FnZXMvcHJvbXB0LW1vZGVsL2luZGV4LmpzPzBjYWIiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IGZzIGZyb20gXCJmc1wiO1xyXG5cclxuY29uc3QgTU9ERUxfQVBJX1VSTCA9XHJcbiAgXCJodHRwczovL2FwaS1pbmZlcmVuY2UuaHVnZ2luZ2ZhY2UuY28vbW9kZWxzL3NhbGVzZm9yY2UvYmxpcC1pbWFnZS1jYXB0aW9uaW5nLWxhcmdlXCI7XHJcblxyXG4vKipcclxuICogQSBnZW5lcmljIGhlbHBlciB0byBxdWVyeSBhIEh1Z2dpbmcgRmFjZSBJbmZlcmVuY2UgQVBJLlxyXG4gKiBAcGFyYW0ge3N0cmluZ30gYXBpVXJsIFRoZSBmdWxsIFVSTCBvZiB0aGUgbW9kZWwncyBpbmZlcmVuY2UgQVBJLlxyXG4gKiBAcGFyYW0ge0J1ZmZlcn0gZGF0YSBUaGUgZGF0YSB0byBzZW5kIChlLmcuLCBhbiBpbWFnZSBidWZmZXIpLlxyXG4gKiBAcmV0dXJucyB7UHJvbWlzZTxvYmplY3Q+fSBUaGUgSlNPTiByZXNwb25zZSBmcm9tIHRoZSBBUEkuXHJcbiAqL1xyXG5hc3luYyBmdW5jdGlvbiBxdWVyeUh1Z2dpbmdGYWNlKGFwaVVybCwgZGF0YSkge1xyXG4gIGNvbnN0IGFwaUtleSA9IHByb2Nlc3MuZW52LkhVR0dJTkdfRkFDRV9BUElfS0VZO1xyXG4gIGNvbnNvbGUubG9nKFwiSHVnZ2luZyBGYWNlIEFQSSBLZXk6XCIsIGFwaUtleSA/IFwiTG9hZGVkXCIgOiBcIk5PVCBMT0FERURcIik7XHJcblxyXG4gIGlmICghYXBpS2V5KSB7XHJcbiAgICB0aHJvdyBuZXcgRXJyb3IoXCJIdWdnaW5nIEZhY2UgQVBJIGtleSBpcyBub3QgY29uZmlndXJlZC5cIik7XHJcbiAgfVxyXG5cclxuICBjb25zdCByZXNwb25zZSA9IGF3YWl0IGZldGNoKGFwaVVybCwge1xyXG4gICAgaGVhZGVyczoge1xyXG4gICAgICBBdXRob3JpemF0aW9uOiBgQmVhcmVyICR7YXBpS2V5fWAsXHJcbiAgICB9LFxyXG4gICAgbWV0aG9kOiBcIlBPU1RcIixcclxuICAgIGJvZHk6IGRhdGEsXHJcbiAgfSk7XHJcblxyXG4gIGlmICghcmVzcG9uc2Uub2spIHtcclxuICAgIGNvbnN0IHJlc3BvbnNlVGV4dCA9IGF3YWl0IHJlc3BvbnNlLnRleHQoKTtcclxuICAgIGNvbnNvbGUuZXJyb3IoXCJIdWdnaW5nIEZhY2UgQVBJIEVycm9yIFJlc3BvbnNlOlwiLCByZXNwb25zZVRleHQpO1xyXG4gICAgY29uc3QgZXJyb3JNc2cgPSBgSHVnZ2luZyBGYWNlIEFQSSBlcnJvcjogJHtyZXNwb25zZS5zdGF0dXNUZXh0fWA7XHJcbiAgICB0aHJvdyBuZXcgRXJyb3IoZXJyb3JNc2cpO1xyXG4gIH1cclxuXHJcbiAgY29uc3QgcmVzdWx0ID0gYXdhaXQgcmVzcG9uc2UuanNvbigpO1xyXG5cclxuICByZXR1cm4gcmVzdWx0O1xyXG59XHJcblxyXG4vKipcclxuICogR2VuZXJhdGVzIGEgcHJvbXB0IGZyb20gYW4gaW1hZ2UgZmlsZSBieSBjYWxsaW5nIHRoZSBIdWdnaW5nIEZhY2UgSW5mZXJlbmNlIEFQSS5cclxuICogQHBhcmFtIHtzdHJpbmd9IGltYWdlUGF0aCBUaGUgbG9jYWwgcGF0aCB0byB0aGUgaW1hZ2UgZmlsZS5cclxuICogQHJldHVybnMge1Byb21pc2U8c3RyaW5nPn0gVGhlIGdlbmVyYXRlZCBwcm9tcHQgdGV4dC5cclxuICogQHRocm93cyB7RXJyb3J9IElmIHRoZSBBUEkgY2FsbCBmYWlscyBvciB0aGUgQVBJIGtleSBpcyBtaXNzaW5nLlxyXG4gKi9cclxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGdldFByb21wdEZyb21JbWFnZShpbWFnZVBhdGgpIHtcclxuICAvLyBSZWFkIHRoZSBpbWFnZSBmaWxlIGZyb20gdGhlIHRlbXBvcmFyeSBwYXRoXHJcbiAgY29uc3QgaW1hZ2VCdWZmZXIgPSBmcy5yZWFkRmlsZVN5bmMoaW1hZ2VQYXRoKTtcclxuXHJcbiAgY29uc3QgcmVzdWx0ID0gYXdhaXQgcXVlcnlIdWdnaW5nRmFjZShNT0RFTF9BUElfVVJMLCBpbWFnZUJ1ZmZlcik7XHJcblxyXG4gIHJldHVybiByZXN1bHRbMF0/LmdlbmVyYXRlZF90ZXh0IHx8IFwiQ291bGQgbm90IGdlbmVyYXRlIGEgcHJvbXB0IGZvciB0aGlzIGltYWdlLlwiO1xyXG59Il0sIm5hbWVzIjpbImZzIiwiTU9ERUxfQVBJX1VSTCIsInF1ZXJ5SHVnZ2luZ0ZhY2UiLCJhcGlVcmwiLCJkYXRhIiwiYXBpS2V5IiwicHJvY2VzcyIsImVudiIsIkhVR0dJTkdfRkFDRV9BUElfS0VZIiwiY29uc29sZSIsImxvZyIsIkVycm9yIiwicmVzcG9uc2UiLCJmZXRjaCIsImhlYWRlcnMiLCJBdXRob3JpemF0aW9uIiwibWV0aG9kIiwiYm9keSIsIm9rIiwicmVzcG9uc2VUZXh0IiwidGV4dCIsImVycm9yIiwiZXJyb3JNc2ciLCJzdGF0dXNUZXh0IiwicmVzdWx0IiwianNvbiIsImdldFByb21wdEZyb21JbWFnZSIsImltYWdlUGF0aCIsImltYWdlQnVmZmVyIiwicmVhZEZpbGVTeW5jIiwiZ2VuZXJhdGVkX3RleHQiXSwic291cmNlUm9vdCI6IiJ9\n//# sourceURL=webpack-internal:///(api)/../../packages/prompt-model/index.js\n");

/***/ })

};
;

// load runtime
var __webpack_require__ = require("../../webpack-api-runtime.js");
__webpack_require__.C(exports);
var __webpack_exec__ = (moduleId) => (__webpack_require__(__webpack_require__.s = moduleId))
var __webpack_exports__ = __webpack_require__.X(0, ["vendor-chunks/next"], () => (__webpack_exec__("(api)/../../node_modules/next/dist/build/webpack/loaders/next-route-loader/index.js?kind=PAGES_API&page=%2Fapi%2Fgenerate-prompt&preferredRegion=&absolutePagePath=.%2Fpages%5Capi%5Cgenerate-prompt.js&middlewareConfigBase64=e30%3D!")));
module.exports = __webpack_exports__;

})();